---
title: Graph-Style Queries
description: Relationship traversal and graph patterns
---

# Graph-Style Queries

Query by relationships between entities. Traverse connections, filter by related data, and count relationships.

## Basic Relationship Query

```typescript
// Posts by expert authors
const expertPosts = await db.Post.find({
  $rel: {
    type: 'authored',
    from: { type: 'User', where: { role: 'expert' } },
  },
})
```

## Relationship Direction

```typescript
// Outgoing: Post -> Author
const posts = await db.Post.find({
  $rel: {
    type: 'authored',
    from: { type: 'User', where: { name: 'Alice' } },
  },
})

// Incoming: Author <- Post
const authors = await db.User.find({
  $rel: {
    type: 'authored',
    to: { type: 'Post', where: { published: true } },
  },
})
```

## Multi-Hop Traversal

Find entities through chains of relationships:

```typescript
// Posts by users I follow
const feed = await db.Post.find({
  $rel: {
    type: 'authored',
    from: {
      type: 'User',
      where: {
        $rel: {
          type: 'follows',
          to: currentUser.$id,
        },
      },
    },
  },
})
```

### Three-Hop Example

```typescript
// Posts by users who work at companies I invested in
const posts = await db.Post.find({
  $rel: {
    type: 'authored',
    from: {
      type: 'User',
      where: {
        $rel: {
          type: 'works_at',
          to: {
            type: 'Company',
            where: {
              $rel: {
                type: 'invested_in',
                from: currentUser.$id,
              },
            },
          },
        },
      },
    },
  },
})
```

## Relationship Properties

Query relationships that have properties:

```typescript
// Team members with specific role
const leads = await db.User.find({
  $rel: {
    type: 'member',
    to: { type: 'Team', where: { name: 'Engineering' } },
    props: { role: 'lead' },
  },
})

// Relationships created recently
const newFollowers = await db.User.find({
  $rel: {
    type: 'follows',
    to: currentUser.$id,
    props: { createdAt: { $gte: lastWeek } },
  },
})
```

## Counting Relationships

```typescript
// Posts with 100+ likes
const popular = await db.Post.find({
  $relCount: {
    type: 'likes',
    to: '$self',
    $gte: 100,
  },
})

// Users with many followers
const influencers = await db.User.find({
  $relCount: {
    type: 'follows',
    to: '$self',
    $gte: 10000,
  },
})

// Posts with few comments (engagement opportunity)
const needsEngagement = await db.Post.find({
  $relCount: {
    type: 'commented',
    to: '$self',
    $lt: 5,
  },
})
```

### Count Operators

| Operator | Description | Example |
|----------|-------------|---------|
| `$eq` | Exact count | `{ $relCount: { ..., $eq: 10 } }` |
| `$gt` | More than | `{ $relCount: { ..., $gt: 100 } }` |
| `$gte` | At least | `{ $relCount: { ..., $gte: 50 } }` |
| `$lt` | Less than | `{ $relCount: { ..., $lt: 5 } }` |
| `$lte` | At most | `{ $relCount: { ..., $lte: 10 } }` |

## Combining with Other Styles

Graph queries combine with SQL and Document styles:

```typescript
// Viral posts from verified authors in my network
const viral = await db.Post.find({
  // SQL-style
  publishedAt: { $gte: lastWeek },

  // Document-style
  'metadata.wordCount': { $gte: 1000 },
  tags: { $containsAll: ['ai', 'tutorial'] },

  // Graph-style: relationship
  $rel: {
    type: 'authored',
    from: {
      type: 'User',
      where: {
        verified: true,
        $rel: { type: 'follows', to: currentUser.$id },
      },
    },
  },

  // Graph-style: count
  $relCount: { type: 'likes', to: '$self', $gte: 50 },
})
```

## Real-World Examples

### Social Feed

```typescript
// Home feed: posts from followed users, sorted by engagement
const feed = await db.Post.find({
  $rel: {
    type: 'authored',
    from: {
      type: 'User',
      where: {
        $rel: { type: 'follows', to: currentUser.$id },
      },
    },
  },
  publishedAt: { $gte: lastDay },
  orderBy: 'engagement',
  order: 'desc',
  limit: 50,
})
```

### Team Permissions

```typescript
// Users who can access a project
const authorized = await db.User.find({
  $or: [
    // Direct project members
    { $rel: { type: 'member', to: project.$id } },
    // Team members where team has project access
    {
      $rel: {
        type: 'member',
        to: {
          type: 'Team',
          where: {
            $rel: { type: 'has_access', to: project.$id },
          },
        },
      },
    },
    // Organization admins
    {
      role: 'admin',
      $rel: { type: 'member', to: project.organization },
    },
  ],
})
```

### Recommendation Engine

```typescript
// Users who might like a post (friends of people who liked it)
const potential = await db.User.find({
  $rel: {
    type: 'follows',
    from: {
      type: 'User',
      where: {
        $rel: { type: 'likes', to: post.$id },
      },
    },
  },
  // Exclude users who already liked it
  $not: {
    $rel: { type: 'likes', to: post.$id },
  },
})
```

### E-commerce

```typescript
// Products bought together with current product
const alsoBought = await db.Product.find({
  $rel: {
    type: 'in_order',
    from: {
      type: 'Order',
      where: {
        $rel: { type: 'contains', to: currentProduct.$id },
      },
    },
  },
  $id: { $ne: currentProduct.$id },
})
```

## Graph Operators Reference

| Operator | Description |
|----------|-------------|
| `$rel` | Filter by relationship |
| `$relCount` | Count relationships |
| `type` | Relationship type name |
| `from` | Source entity filter |
| `to` | Target entity filter |
| `props` | Relationship properties |
| `$self` | Reference to current entity |
