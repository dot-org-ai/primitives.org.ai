---
title: Replaying Events
description: Replay events for recovery and reprocessing
---

# Replaying Events

Replay historical events for recovery, reprocessing, or debugging.

## Basic Replay

```typescript
await db.events.replay({
  handler: async (event) => {
    console.log(event.type, event.url)
  },
})
```

## Filtered Replay

### By Time

```typescript
// Replay from checkpoint
await db.events.replay({
  since: lastCheckpoint,
  handler: async (event) => {
    await reprocess(event)
  },
})

// Replay time range
await db.events.replay({
  since: startTime,
  until: endTime,
  handler: processEvent,
})
```

### By Type

```typescript
// Replay specific event type
await db.events.replay({
  type: 'Post.created',
  handler: async (event) => {
    await reindexPost(event)
  },
})

// Replay with wildcard
await db.events.replay({
  type: 'Post.*',
  handler: processPostEvent,
})
```

### By Entity

```typescript
// Replay events for specific entity
await db.events.replay({
  url: 'posts/hello-world',
  handler: async (event) => {
    console.log(event.type, event.timestamp)
  },
})
```

## Use Cases

### Recovery After Failure

```typescript
// Get last processed event
const checkpoint = await getCheckpoint()

// Replay from checkpoint
await db.events.replay({
  since: checkpoint,
  handler: async (event) => {
    await processEvent(event)
    await saveCheckpoint(event.timestamp)
  },
})
```

### Reindexing Search

```typescript
await db.events.replay({
  type: '*.created',
  handler: async (event) => {
    await searchIndex.add(event.url, event.data)
  },
})
```

### Rebuilding Derived Data

```typescript
// Rebuild analytics from events
const stats = { created: 0, updated: 0, deleted: 0 }

await db.events.replay({
  since: startOfMonth,
  type: 'Post.*',
  handler: (event) => {
    if (event.type.endsWith('.created')) stats.created++
    if (event.type.endsWith('.updated')) stats.updated++
    if (event.type.endsWith('.deleted')) stats.deleted++
  },
})

console.log('This month:', stats)
```

### Debugging

```typescript
// What happened to this entity?
await db.events.replay({
  url: 'posts/disappeared',
  handler: (event) => {
    console.log(`${event.timestamp}: ${event.type}`)
    console.log('  by:', event.actor)
    console.log('  data:', event.data)
  },
})
```

### Migration

```typescript
// Apply transformation to all entities
await db.events.replay({
  type: '*.created',
  handler: async (event) => {
    // Add new field to all entities
    await db[event.type.split('.')[0]].update(event.url, {
      migratedAt: new Date(),
    })
  },
})
```

## Batch Processing

```typescript
const batch = []
const BATCH_SIZE = 100

await db.events.replay({
  type: 'Post.created',
  handler: async (event) => {
    batch.push(event)

    if (batch.length >= BATCH_SIZE) {
      await processBatch(batch)
      batch.length = 0
    }
  },
})

// Process remaining
if (batch.length > 0) {
  await processBatch(batch)
}
```

## Progress Tracking

```typescript
let processed = 0
const startTime = Date.now()

await db.events.replay({
  since: lastMonth,
  handler: async (event) => {
    await processEvent(event)
    processed++

    if (processed % 1000 === 0) {
      const elapsed = (Date.now() - startTime) / 1000
      console.log(`Processed ${processed} events (${processed / elapsed}/s)`)
    }
  },
})
```

## Error Handling

```typescript
const errors = []

await db.events.replay({
  type: 'Post.*',
  handler: async (event) => {
    try {
      await processEvent(event)
    } catch (error) {
      errors.push({ event, error })
      // Continue processing other events
    }
  },
})

if (errors.length > 0) {
  console.log(`${errors.length} events failed:`)
  for (const { event, error } of errors) {
    console.log(`  ${event.url}: ${error.message}`)
  }
}
```

## Idempotent Handlers

Replay handlers should be idempotent (safe to run multiple times):

```typescript
// Good: idempotent
await db.events.replay({
  type: 'Post.created',
  handler: async (event) => {
    // Uses upsert - safe to run multiple times
    await searchIndex.upsert(event.url, event.data)
  },
})

// Bad: not idempotent
await db.events.replay({
  type: 'Post.created',
  handler: async (event) => {
    // Creates duplicate each time
    await searchIndex.add(event.url, event.data)
  },
})
```

## Parallel Replay

```typescript
import pLimit from 'p-limit'

const limit = pLimit(10)  // 10 concurrent

const events = await db.events.list({ type: 'Post.*' })

await Promise.all(
  events.map(event =>
    limit(() => processEvent(event))
  )
)
```
