---
title: Events & Actions
description: Durable execution, event logs, and cached artifacts
---

# Events & Actions

ai-database provides primitives for durable execution and reactive workflows.

## Events

Every mutation emits an immutable event:

```typescript
// Events are automatically emitted
await db.Post.create({ title: 'Hello' })
// Emits: Post.created { url, data, timestamp }

await db.Post.update(id, { published: true })
// Emits: Post.updated { url, data, changes, timestamp }

await db.Post.delete(id)
// Emits: Post.deleted { url, timestamp }
```

### Querying Events

```typescript
const events = await db.events.list({
  type: 'Post.*',           // glob patterns supported
  since: new Date('2024-01-01'),
  until: new Date(),
  limit: 100,
})
```

### Subscribing to Events

```typescript
// Specific event type
db.events.on('Post.created', async (event) => {
  await db.generate({
    type: 'social-posts',
    data: { post: event.url },
  })
})

// Wildcard subscription
db.events.on('*.created', async (event) => {
  console.log(`Created: ${event.url}`)
})
```

### Replaying Events

```typescript
await db.events.replay({
  type: 'Post.*',
  since: checkpoint,
  handler: async (event) => {
    await reindex(event.url)
  },
})
```

### Event Types

| Event | Emitted When |
|-------|--------------|
| `{Type}.created` | Record created |
| `{Type}.updated` | Record updated |
| `{Type}.deleted` | Record deleted |
| `{Type}.generated` | Record generated by AI |
| `Relation.created` | Relationship created |
| `Relation.deleted` | Relationship deleted |
| `Action.started` | Action began execution |
| `Action.completed` | Action finished successfully |
| `Action.failed` | Action failed |

## Actions

Long-running operations execute as durable Actions:

```typescript
// Background generation
const action = await db.generate({
  type: 'posts',
  count: 100,
  data: { blog: blog.url },
  mode: 'background',
})
// { id: 'action_abc123', status: 'pending' }

// Check status
const status = await db.action.get(action.id)
// { id: 'action_abc123', status: 'active', progress: 47, total: 100 }

// Wait for completion
const posts = await action.result()
```

### Action Management

```typescript
// List by status
const pending = await db.action.list({ status: 'pending' })
const active = await db.action.list({ status: 'active' })
const failed = await db.action.list({ status: 'failed' })

// Retry failed action
await db.action.retry(action.id)

// Cancel pending/active action
await db.action.cancel(action.id)
```

### Action Status Flow

```
pending → active → completed
                 ↘ failed → (retry) → pending
```

### Action Features

- **Durability** - Survives restarts, resumes from last checkpoint
- **Progress tracking** - Real-time status and progress
- **Retry logic** - Automatic retries with backoff
- **Batching** - Group operations for cost savings
- **Queuing** - Rate limiting and concurrency control

## Artifacts

Artifacts store computed content with automatic invalidation:

```typescript
// Embeddings are stored as artifacts automatically
const post = await db.Post.create({ content })
// Creates artifact: { type: 'embedding', sourceHash, vectors }

// Access artifacts
const embedding = await db.artifact.get(post.url, 'embedding')
// { vectors: Float32Array, model: 'google/gemini-embedding-001', dimensions: 3072 }

// Store custom artifacts
await db.artifact.set(post.url, 'html', {
  content: renderedHtml,
  sourceHash: hash(post.data.content),
})

// Delete artifacts
await db.artifact.delete(post.url, 'html')  // specific type
await db.artifact.delete(post.url)          // all for record
```

### Cache Invalidation

Artifacts auto-invalidate when the source changes:

```typescript
await db.Post.update(id, { content: newContent })
// Embedding artifact is regenerated
// Custom artifacts return null until rebuilt
```

### Artifact Types

| Type | Description |
|------|-------------|
| `embedding` | Vector embeddings (auto-generated) |
| `chunks` | Chunked content for search |
| `ast` | Parsed abstract syntax tree |
| `html` | Rendered HTML |
| `bundle` | Bundled JavaScript/CSS |
| Custom | Any string type you define |

## Usage Example

Combine events, actions, and artifacts:

```typescript
// Subscribe to post creation
db.events.on('Post.created', async (event) => {
  const post = await db.Post.get(event.url)

  // Start background action to generate social posts
  const action = await db.generate({
    type: 'social-posts',
    count: 5,
    data: { post: post.url },
    mode: 'background',
  })

  // Store action reference as artifact
  await db.artifact.set(post.url, 'social-generation', {
    actionId: action.id,
    startedAt: new Date(),
  })
})

// Check generation progress
async function getSocialProgress(postUrl: string) {
  const artifact = await db.artifact.get(postUrl, 'social-generation')
  if (!artifact) return null

  const action = await db.action.get(artifact.actionId)
  return {
    progress: action.progress,
    total: action.total,
    status: action.status,
  }
}
```
